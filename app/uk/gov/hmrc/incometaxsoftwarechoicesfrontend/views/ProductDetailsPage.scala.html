@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.govukfrontend.views.html.components._
@import uk.gov.hmrc.govukfrontend.views.viewmodels.breadcrumbs.{Breadcrumbs, BreadcrumbsItem}
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content.Text
@import uk.gov.hmrc.hmrcfrontend.views.html.helpers.HmrcNewTabLinkHelper
@import uk.gov.hmrc.hmrcfrontend.views.viewmodels.newtablinkhelper.NewTabLinkHelper
@import uk.gov.hmrc.incometaxsoftwarechoicesfrontend.config.AppConfig
@import uk.gov.hmrc.incometaxsoftwarechoicesfrontend.controllers.routes.SearchSoftwareController
@import uk.gov.hmrc.incometaxsoftwarechoicesfrontend.models.VendorFilter._
@import uk.gov.hmrc.incometaxsoftwarechoicesfrontend.models._
@import uk.gov.hmrc.incometaxsoftwarechoicesfrontend.views.html.templates.MainTemplate

@this(
  mainTemplate: MainTemplate,
  breadcrumbs: GovukBreadcrumbs,
  hmrcNewTabLinkHelper: HmrcNewTabLinkHelper,
  govukSummaryList : GovukSummaryList
)(implicit appConfig: AppConfig)
@(softwareVendor: SoftwareVendorModel, displayIncomeAndDeductionTypes: Boolean)(implicit request: Request[_], messages: Messages)

@mainTemplate(title = messages("product-details.title"), breadcrumbs = Some(pageBreadcrumbs)) {

  @contactDetails

  @productDetails

  @if(displayIncomeAndDeductionTypes) {
    @incomeAndDeductionTypes
  }

  @softwareVendor.accessibilityStatementLink.map(linkText => accessibilityStatement(linkText))

}

@pageBreadcrumbs = {
  @breadcrumbs(Breadcrumbs(
    items = Seq(
      BreadcrumbsItem(
        content = Text(messages("breadcrumbs.guidance")),
        href = Some(appConfig.guidance)
      ),
      BreadcrumbsItem(
        content = Text(messages("breadcrumbs.filter")),
        href = Some(SearchSoftwareController.show.url)
      ),
      BreadcrumbsItem(
        content = Text(messages("breadcrumbs.details")),
        href = None
      )
    )
  ))
}

@contactDetails = {
  <h2 class="govuk-heading-l">@messages("product-details.contact-details.heading")</h2>

  @govukSummaryList(SummaryList(
    rows = Seq(
      SummaryListRow(
        key = Key(content = Text(s"${messages("product-details.contact-details.email")}:")),
        value = Value(content = HtmlContent(link(href = s"mailto:${softwareVendor.email}", text = softwareVendor.email)))
      ),
      SummaryListRow(
        key = Key(content = Text(s"${messages("product-details.contact-details.phone")}:")),
        value = Value(content = Text(softwareVendor.phone))
      ),
      SummaryListRow(
        key = Key(content = Text(s"${messages("product-details.contact-details.website")}:")),
        value = Value(content = HtmlContent(link(href = softwareVendor.website, text = softwareVendor.website)))
      )
    )
  ))
}

@productDetails = {
  <h2 class="govuk-heading-l">@messages("product-details.details.heading")</h2>

  @govukSummaryList(SummaryList(
    rows = Seq(
      pricingRow,
      incomeTypeRow,
      compatibleWithRow,
      mobileAppRow,
      softwareTypeRow,
      softwareForRow,
      businessTypeRow,
      softwareCompatibilityRow,
      languageRow,
      accessibilityRow
    ).flatten
  ))
}

@incomeAndDeductionTypes = {
  <h2 class="govuk-heading-l">@messages("product-details.income-and-deduction-types.heading")</h2>

  <p class="govuk-body">
    @messages(
      "product-details.income-and-deduction-types.number-covered",
      softwareVendor.name,
      softwareVendor.incomeAndDeductions.length,
      IncomeAndDeduction.incomeAndDeductionKeyToIncomeAndDeduction.toSeq.length
    )
  </p>

  <ol class="govuk-list govuk-list--number">
    @softwareVendor.incomeAndDeductions.map { incomeAndDeduction =>
      <li>@messages(s"product-details.income-and-deduction-types.${incomeAndDeduction.key}")</li>
    }
  </ol>
}

@accessibilityStatement(linkText: String) = {
  <h2 class="govuk-heading-l">@{messages("product-details.accessibility-statement.heading")}</h2>
  @govukSummaryList(SummaryList(
    rows = Seq(
      SummaryListRow(
        key = Key(content = Text(messages("product-details.accessibility-statement.key"))),
        value = Value(content = HtmlContent(link(linkText, linkText)))
      )
    )
  ))
}

@productDetailsRow(key: String, filtersInRow: Seq[VendorFilter]) = @{

  val rowContentMessages = softwareVendor.filters.filter(filtersInRow.contains).map { filter =>
    messages(s"product-details.details.${filter.key}")
  }.map { value =>
    <p class="govuk-body">{value}</p>
  }.mkString

  if(rowContentMessages.isEmpty) {
    None
  } else {
    Some(SummaryListRow(
      key = Key(
        content = Text(messages(s"product-details.details.$key"))
      ),
      value = Value(
        content = HtmlContent(
          rowContentMessages
        )
      )
    ))
  }
}

@pricingRow = @{
  productDetailsRow(
    key = "pricing",
    filtersInRow = Seq(FreeTrial, FreeVersion, PaidFor)
  )
}

@incomeTypeRow = @{
  productDetailsRow(
    key = "income-type",
    filtersInRow = Seq(SoleTrader, UkProperty, OverseasProperty)
  )
}

@compatibleWithRow = @{
  productDetailsRow(
    key = "compatible-with",
    filtersInRow = Seq(MicrosoftWindows, MacOS)
  )
}

@mobileAppRow = @{
  productDetailsRow(
    key = "mobile-app",
    filtersInRow = Seq(Android, AppleIOS)
  )
}

@softwareTypeRow = @{
  productDetailsRow(
    key = "software-type",
    filtersInRow = Seq(BrowserBased, ApplicationBased)
  )
}

@softwareForRow = @{
  productDetailsRow(
    key = "software-for",
    filtersInRow = Seq(RecordKeeping, Bridging)
  )
}

@businessTypeRow = @{
  productDetailsRow(
    key = "business-type",
    filtersInRow = Seq(Individual, Agent)
  )
}

@softwareCompatibilityRow = @{

  val incomeTaxContent = s"<p class='govuk-body'>${messages("product-details.details.income-tax")}</p>"
  val vatContent = softwareVendor.filters.find(_ == Vat).map(filter => <p class='govuk-body'>{messages(s"product-details.details.${filter.key}")}</p>).getOrElse("")

  Some(SummaryListRow(
    key = Key(
      content = Text(messages("product-details.details.software-compatibility"))
    ),
    value = Value(
      content = HtmlContent(incomeTaxContent + vatContent)
    )
  ))
}

@accessibilityRow = @{
  productDetailsRow(
    key = "accessibility",
    filtersInRow = Seq(Visual, Hearing, Motor, Cognitive)
  )
}

@languageRow = @{
  productDetailsRow(
    key = "language",
    filtersInRow = Seq(Welsh)
  )
}

@link(href: String, text: String) = {
  <a class="govuk-link" href="@href">@text</a>
}
